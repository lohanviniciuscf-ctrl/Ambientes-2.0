<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM Premium</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0a192f;
  --card:#112240;
  --accent:#64ffda;
  --text:#e6f1ff;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,var(--bg),#020c1b);
  color:var(--text);
  transition:.4s;
}
button,input{
  padding:10px;
  border:none;
  border-radius:10px;
  font-family:'Poppins';
}
button{cursor:pointer;font-weight:600}
.center{min-height:100vh;display:flex;align-items:center;justify-content:center}
.box{background:var(--card);padding:35px;border-radius:22px;width:380px;text-align:center}
.hidden{display:none}
.metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:25px}
.metric{background:var(--card);padding:20px;border-radius:20px;text-align:center}
.form{background:var(--card);padding:20px;border-radius:20px;margin-bottom:25px}
.lead{background:#fff;color:#000;padding:18px;border-radius:18px;margin-bottom:15px}
</style>
</head>

<body>

<div id="envSelect" class="center">
  <div class="box">
    <h2>ğŸŒ Escolha o ambiente</h2><br>
    <button onclick="selectEnv('Modelle')">ğŸ‘©â€ğŸ¦° Modelle Skin</button><br><br>
    <button onclick="selectEnv('Cia')">ğŸ“’ Cia & Arte</button><br><br>
    <button onclick="selectEnv('Thalles')">ğŸŒ¬ï¸ Thalles ClimatizaÃ§Ã£o</button>
  </div>
</div>

<div id="loginScreen" class="center hidden">
  <div class="box">
    <button onclick="backToEnv()">â¬… Voltar</button>
    <h2 id="envTitle"></h2><br>
    <input id="user" placeholder="UsuÃ¡rio"><br><br>
    <input id="pass" type="password" placeholder="Senha"><br><br>
    <button onclick="login()">Entrar</button>
    <div id="loginError"></div>
  </div>
</div>

<div id="app" class="hidden" style="padding:30px">
<header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px">
  <h2 id="appTitle"></h2>
  <div>
    <button onclick="exportCSV()">â¬‡ CSV</button>
    <button onclick="logout()">Sair</button>
  </div>
</header>

<div id="metrics" class="metrics"></div>
<div class="form" id="formArea"></div>
<div id="lista"></div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycby0k9Gi5PzBlGc3eeNcilGVYOiZUcKDX7OqhSFNOHfeQKJZ0D_qozWelrk5Xne9Spc3/exec";

const users={
 Lohan:{pass:"D9f0da85",env:["Modelle","Cia","Thalles"]},
 Marcus:{pass:"Elistray6001",env:["Cia"]},
 Queila:{pass:"alieuq79",env:["Modelle"]},
 Hamonny:{pass:"climatizaÃ§Ã£o",env:["Thalles"]}
};

let env=null,userAtual=null,pedidos=[];

function selectEnv(e){
 env=e;
 envSelect.classList.add("hidden");
 loginScreen.classList.remove("hidden");
 envTitle.innerText=e;
}

function backToEnv(){
 loginScreen.classList.add("hidden");
 envSelect.classList.remove("hidden");
}

function login(){
 if(users[user.value] && users[user.value].pass===pass.value && users[user.value].env.includes(env)){
  userAtual=user.value;
  loginScreen.classList.add("hidden");
  app.classList.remove("hidden");
  appTitle.innerText=env+" â€” "+userAtual;
  loadPedidos();
 }else loginError.innerText="Login invÃ¡lido";
}

function logout(){location.reload()}

async function loadPedidos(){
 const r=await fetch(API_URL+"?env="+env);
 const data=await r.json();
 pedidos=data.slice(1).map((l,i)=>({
  usuario:l[1],
  desc:l[2],
  valor:+l[3],
  custo:+l[4]||0,
  ordinario:+l[5]||0,
  lucro:+l[6]||0,
  data:l[l.length-1]
 }));
 render();
}

async function addPedido(){
 let body;
 if(env==="Modelle"){
  body=[env,userAtual,desc.value,+valor.value,new Date().toLocaleDateString()];
 }else{
  let lucro=valor.value-(+custo.value + +ordinario.value);
  body=[env,userAtual,desc.value,+valor.value,+custo.value,+ordinario.value,lucro,new Date().toLocaleDateString()];
 }
 await fetch(API_URL,{method:"POST",body:JSON.stringify(body)});
 loadPedidos();
}

function render(){
 let total=0,custos=0;
 pedidos.forEach(p=>{
  total+=p.valor;
  if(env!=="Modelle") custos+=(p.custo+p.ordinario);
 });
 let lucro=total-custos;
 let comissao=total*0.01;

 metrics.innerHTML = env==="Modelle" ? `
  <div class="metric">Pedidos<br><strong>${pedidos.length}</strong></div>
  <div class="metric">Total<br><strong>R$ ${total.toFixed(2)}</strong></div>
  <div class="metric">ComissÃ£o<br><strong>R$ ${comissao.toFixed(2)}</strong></div>
 ` : `
  <div class="metric">Pedidos<br><strong>${pedidos.length}</strong></div>
  <div class="metric">Faturamento<br><strong>R$ ${total.toFixed(2)}</strong></div>
  <div class="metric">Custos<br><strong>R$ ${custos.toFixed(2)}</strong></div>
  <div class="metric">Lucro<br><strong>R$ ${lucro.toFixed(2)}</strong></div>
 `;

 formArea.innerHTML = env==="Modelle" ? `
  <input id="desc" placeholder="O que Ã© o pedido"><br><br>
  <input id="valor" type="number" placeholder="Valor"><br><br>
  <button onclick="addPedido()">Adicionar</button>
 ` : `
  <input id="desc" placeholder="DescriÃ§Ã£o"><br><br>
  <input id="valor" type="number" placeholder="Valor"><br><br>
  <input id="custo" type="number" placeholder="Custo"><br><br>
  <input id="ordinario" type="number" placeholder="Custos ordinÃ¡rios"><br><br>
  <button onclick="addPedido()">Adicionar</button>
 `;

 lista.innerHTML="";
 pedidos.forEach(p=>{
  lista.innerHTML+=`
   <div class="lead">
    <strong>${p.desc}</strong><br>
    ğŸ’° R$ ${p.valor}<br>
    ${env!=="Modelle"?`ğŸ“‰ Custos: R$ ${(p.custo+p.ordinario)}<br>ğŸ“ˆ Lucro: R$ ${p.lucro}<br>`:""}
    <small>ğŸ‘¤ ${p.usuario} â€¢ ğŸ“… ${p.data}</small>
   </div>
  `;
 });
}

function exportCSV(){
 let csv="UsuÃ¡rio,DescriÃ§Ã£o,Valor,Data\n";
 pedidos.forEach(p=>{
  csv+=`${p.usuario},${p.desc},${p.valor},${p.data}\n`;
 });
 const blob=new Blob([csv],{type:"text/csv"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download=env+"_consolidado.csv";
 a.click();
}
</script>

</body>
</html>
